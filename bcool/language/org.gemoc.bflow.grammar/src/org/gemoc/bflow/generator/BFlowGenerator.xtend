/*
 * generated by Xtext
 */
package org.gemoc.bflow.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.IGenerator
import org.eclipse.xtext.generator.IFileSystemAccess
import org.gemoc.bflow.bFlow.Model
import org.gemoc.bflow.bFlow.Flows
import org.gemoc.bcool.model.bcool.BCoolSpecification

/**
 * Generates code from your model files on save.
 * 
 * see http://www.eclipse.org/Xtext/documentation.html#TutorialCodeGeneration
 */
class BFlowGenerator implements IGenerator {
	
	
	override void doGenerate(Resource resource, IFileSystemAccess fsa) {
	var String output = ""
	
	for(e: resource.allContents.toIterable.filter(Model)) {
		if (e.outputtimemodel.nullOrEmpty) {
    	for(l: e.launchers) {
    		output += l.launcherURI.substring(l.launcherURI.lastIndexOf("/")+1)
			}
		output = "./" + output + ".timemodel"}
		else {output = e.outputtimemodel}
	}
	
    for(e: resource.allContents.toIterable.filter(Model)) {
      fsa.generateFile(
        "../gemoc-gen/"+e.name  + ".xml",
        e.compile(output))
	}
}

def compile(Model e, String output) '''
<?xml version="1.0" encoding="UTF-8"?>
<project name="«e.name»" default="default" xmlns:qvto="http://www.eclipse.org/qvt/1.0.0/Operational">
<target name="default">


	«var bcooluri = e.importURI»

	«var outputmodel = output»
	
	    <qvto:transformation
        uri="platform:/plugin/org.gemoc.bflow.grammar/qvto-helper/createTimeModel.qvto"
        >
    
        <out
            uri="«outputmodel»"
        />
    	
    	<configProperty
        name="nameCCSLSpec"
        value="«e.name»"
    	
    	 />
    </qvto:transformation>
	
	     «FOR f:e.bcoolflow»
	     	«var BCoolSpecification transfoname= f.operator.eContainer.eContainer as BCoolSpecification»
	     	«IF bcooluri.startsWith("platform:/resource")» 
	     	   <qvto:transformation uri="«bcooluri.substring (0,bcooluri.indexOf("/", ("platform:/resource/").length)) + "/gemoc-gen/" + transfoname.name + ".qvto"»">
	     	«ELSEIF bcooluri.startsWith("platform:/plugin")»
	     		<qvto:transformation uri="«bcooluri.substring (0,bcooluri.indexOf("/", ("platform:/plugin/").length)) + "/gemoc-gen/" + transfoname.name + ".qvto"»">
	     	«ELSE»
	     		<qvto:transformation uri="«transfoname.name  + ".qvto"»">
	     	«ENDIF»
	     	<configProperty name="ApplyAll" value="false"/>
	     	«IF f == e.bcoolflow.get(0)» 
	     		<configProperty name="IsInvokedfromAnt" value="true"/>
	     	«ENDIF»
	     	<configProperty name="Is«f.operator.name»Executed" value="true"/>
       		 «f.compile»
	     	<inout uri="«outputmodel»" outuri="«outputmodel»"/>
	     	</qvto:transformation>
         «ENDFOR»
         
    </target>
</project>
'''

def compile(Flows f) '''
«var i=0»
         «FOR e:f.params»
         	<in uri="«e.modeluri»"/>
         	«var timemodel = e.modeluri.substring (0,e.modeluri.indexOf("/", ("platform:/resource/").length))+ "/gemoc-gen/"+ e.modeluri.substring (e.modeluri.lastIndexOf("/")+1,e.modeluri.lastIndexOf(".")) + ".timemodel"»
         	<configProperty name="inM«i=i+1»MoCCPath" value="«timemodel»"/>
         «ENDFOR»
'''
}
